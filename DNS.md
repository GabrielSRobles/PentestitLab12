# DNS

So, the token should be in a DNS server or something like that.

We did get a new OpenVPN config file, lets start by connecting to the VPN.

`sudo openvpn --config vpn.conf`

We use the credentials of the user we found previously on the Mail challenge **info@test.lab**:**123456789**

Lets pay attention to the output now:

`ROUTE_GATEWAY 172.16.37.2/255.255.255.0 IFACE=ens33 HWADDR=00:0c:29:90:e2:ff`

Lets see how our new interface *tun1* is working

`ip ro show dev tun1`

This will show us the IP segment we can access from this device

```
10.11.0.1 via 10.11.0.25 
10.11.0.25 proto kernel scope link src 10.11.0.26 
172.16.0.0/16 via 10.11.0.25 
```

This shows we have access to the network segmenet **172.16.0.0/16**. 

## Info gathering

We want to get all the information that the DNS has, with a feature of DNS servers called **Zone Transfer**. This will provide us with all the servers that the DNS provides.

We do not have a target IP right now for the DNS, lets run an nmap on this segment of the network.

First we go ahead with a ping scan on the network:

`nmap -n -sP 172.16.0.0/16`

* This is going to take forever

This finds the following UP hosts:

* 172.16.0.10
* 172.16.0.17

We run a service scan on these IPs to get information on what services they are running.

### 172.16.0.10

```
PORT   STATE SERVICE VERSION
80/tcp open  http    nginx 1.16.0
```

We have a single open port 80, with the same site as the one we saw before...

### 172.16.0.17

```
PORT     STATE SERVICE      VERSION
22/tcp   open  ssh          OpenSSH 7.4p1 Debian 10+deb9u4 (protocol 2.0)
25/tcp   open  smtp         Postfix smtpd
53/tcp   open  domain       ISC BIND 9.10.3-P4-Debian
80/tcp   open  http         nginx 1.16.0
88/tcp   open  kerberos-sec Heimdal Kerberos (server time: 2019-05-28 18:19:26Z)
135/tcp  open  msrpc        Microsoft Windows RPC
139/tcp  open  netbios-ssn  Samba smbd 3.X - 4.X (workgroup: TEST)
143/tcp  open  imap         Dovecot imapd
445/tcp  open  netbios-ssn  Samba smbd 3.X - 4.X (workgroup: TEST)
464/tcp  open  kpasswd5?
636/tcp  open  ssl/ldap     (Anonymous bind OK)
1024/tcp open  msrpc        Microsoft Windows RPC
3268/tcp open  ldap         (Anonymous bind OK)
3269/tcp open  ssl/ldap     (Anonymous bind OK)
8080/tcp open  http         nginx
Service Info: Hosts: -mail.test.lab, AD; OSs: Linux, Windows; CPE: cpe:/o:linux:linux_kernel, cpe:/o:microsoft:windows
```

Once again, we have the same site on port 80. But something to consider is that this server might be the same as the one we started with, but with more ports accesible.

It has all the same ports the 192.168.101.12 had (25,80,143,8080) and is running the same services. 

What interests us at this point is the port 53, which is running a domain service.

Sadly, this server does not have zonetransfer enabled and wont give us the information we desire. We can use **dig** or **host** to try to retrieve the information:

* host -t axfr test.lab 172.16.0.17
* dig axfr test.lab @172.16.0.17

Both of these comands will fail. But we can search for another DNS server from this one.

We will be using nslookup, based on the server we have, to search for other DNS servers that contain this domain. 

```
nslookup
> server 172.16.0.17
> set type=ns
> test.lab
```

This shows us the following output:
```
Server:		172.16.0.17
Address:	172.16.0.17#53

test.lab	nameserver = ns1.test.lab.
test.lab	nameserver = ns2.test.lab.
```

Which indicates that there are 2 DNS that resolve this name. One of these should be ours, and the other an unknown, which our nmap so far hasn't managed to find.

We ask our DNS server to tell us the the IP for ns1.test.lab

```
nslookup
> server 172.16.0.17
> ns1.test.lab
```
```
Name:	ns1.test.lab
Address: 172.16.0.17
```

So, this is the server we already had. Lets try **ns2**
```
nslookup
> server 172.16.0.17
> ns2.test.lab
```
```
Name:	ns2.test.lab
Address: 172.16.2.10
```
Great, this is a new DNS server. Those are good news. Lets try with nmap and see what it has: `nmap -sV 172.16.2.10`. Sadly this gives us an error `Host seems down. If it is really up, but blocking our ping probes, try -Pn`. That explains why our ping scan nmap didn't work. Lets use the **-Pn** flag.

```
PORT   STATE SERVICE VERSION
53/tcp open  domain  ISC BIND 9.10.3-P4-Debian
```

Okey, it only has the DNS server in the default port. Lets try our Zone Transfer again.

## Getting info from the DNS

Lets run the command we spoke of before, but for our new server:
```
host -t axfr test.lab 172.16.2.10
```
The output this time is much more rewarding.

```
; <<>> DiG 9.11.3-1ubuntu1.3-Ubuntu <<>> axfr test.lab @172.16.2.10
;; global options: +cmd
test.lab.		21600	IN	SOA	test.lab. ad.test.lab. 69 5 30 21600 60
test.lab.		21600	IN	NS	ns1.test.lab.
test.lab.		21600	IN	NS	ns2.test.lab.
test.lab.		21600	IN	A	172.16.0.17
_kerberos._tcp.dc._msdcs.test.lab. 21600 IN SRV	0 0 88 test.lab.
_ldap._tcp.dc._msdcs.test.lab. 21600 IN	SRV	0 0 389 test.lab.
gc._msdcs.test.lab.	21600	IN	A	172.16.0.17
_ldap._tcp.gc._msdcs.test.lab. 21600 IN	SRV	0 0 3268 test.lab.
_kerberos._tcp.test.lab. 21600	IN	SRV	0 0 88 test.lab.
_kpasswd._tcp.test.lab.	21600	IN	SRV	0 0 464 test.lab.
_ldap._tcp.test.lab.	21600	IN	SRV	0 0 389 test.lab.
_kerberos._udp.test.lab. 21600	IN	SRV	0 0 88 test.lab.
_kpasswd._udp.test.lab.	21600	IN	SRV	0 0 464 test.lab.
ad.test.lab.		21600	IN	A	172.16.0.17
db.test.lab.		21600	IN	A	172.16.0.30
dc.test.lab.		21600	IN	A	172.16.0.17
dns.test.lab.		21600	IN	A	172.16.0.17
dns.test.lab.		21600	IN	A	172.16.2.10
_ldap._tcp.ForestDnsZones.test.lab. 21600 IN SRV 0 0 389 test.lab.
helpdesk.test.lab.	21600	IN	A	172.16.0.10
my.test.lab.		21600	IN	A	172.16.0.10
ns1.test.lab.		21600	IN	A	172.16.0.17
ns2.test.lab.		21600	IN	A	172.16.2.10
site.test.lab.		21600	IN	A	172.16.0.10
token-dyawg19u9ws.test.lab. 21600 IN	A	127.0.0.1
test.lab.		21600	IN	SOA	test.lab. ad.test.lab. 69 5 30 21600 60
;; Query time: 858 msec
;; SERVER: 172.16.2.10#53(172.16.2.10)
;; WHEN: Tue May 28 12:22:09 PDT 2019
;; XFR size: 26 records (messages 1, bytes 778)
```

Looking at this info we see a lot of sites defined. Among them are some of the services we will be using on other challenges (ad.test.lab, helpdesk.test.lab, etc) and one that contains our dear token.

## About searching for DNS services in a network segment

In this writeup we have made use of the **nslookup** tool to go from one DNS server to another, searching for our zone transfer. I went with this approach because I was running an **nmap ping scan** and that did not discover the target server, as the server  was avoiding this prove.

This is a more manual way, and will work even if the DNS server is not on the default port (53). **But**, if we know that the DNS servers are in the default port (the most common case), we can simply run the nmap on that port. 

This is much faster, just a few minutes. We just have to remember  to set the **-Pn** to consider all servers as up. We will set the **--open** flag to avoid spamming ourselves with filtered ports

`nmap -Pn -n -p53 172.16.0.0/16`

```
Nmap scan report for 172.16.0.17
Host is up (0.41s latency).

PORT   STATE SERVICE
53/tcp open  domain

Nmap scan report for 172.16.2.10
Host is up (0.31s latency).

PORT   STATE SERVICE
53/tcp open  domain
```